# name: test/sql/faiss_gpu.test
# description: Test FAISS GPU info function and mode=cpu/gpu/auto
# group: [faiss]

require ann

# ========================================
# faiss_gpu_info() always returns a row
# ========================================

query II
SELECT typeof(available), typeof(device) FROM faiss_gpu_info();
----
BOOLEAN	VARCHAR

# available is either true or false
query I
SELECT available IN (true, false) FROM faiss_gpu_info();
----
true

# device is a non-empty string
query I
SELECT length(device) > 0 FROM faiss_gpu_info();
----
true

# ========================================
# mode=cpu — should work everywhere
# ========================================

statement ok
CREATE TABLE vecs (id INT, embedding FLOAT[3]);

statement ok
INSERT INTO vecs VALUES
  (1, [1.0, 0.0, 0.0]),
  (2, [0.0, 1.0, 0.0]),
  (3, [0.0, 0.0, 1.0]);

statement ok
CREATE INDEX cpu_idx ON vecs USING FAISS (embedding) WITH (mode = 'cpu');

query II
SELECT v.id, s.distance
FROM faiss_index_scan('vecs', 'cpu_idx', [1.0, 0.0, 0.0], 1) s
JOIN vecs v ON v.rowid = s.row_id;
----
1	0.0

statement ok
DROP INDEX cpu_idx;

# ========================================
# backward compat: gpu='false' maps to mode=cpu
# ========================================

statement ok
CREATE INDEX compat_cpu ON vecs USING FAISS (embedding) WITH (gpu = 'false');

query II
SELECT v.id, s.distance
FROM faiss_index_scan('vecs', 'compat_cpu', [1.0, 0.0, 0.0], 1) s
JOIN vecs v ON v.rowid = s.row_id;
----
1	0.0

statement ok
DROP INDEX compat_cpu;

# ========================================
# default (no option) — uses auto mode
# ========================================

statement ok
CREATE INDEX auto_idx ON vecs USING FAISS (embedding);

query II
SELECT v.id, s.distance
FROM faiss_index_scan('vecs', 'auto_idx', [1.0, 0.0, 0.0], 1) s
JOIN vecs v ON v.rowid = s.row_id;
----
1	0.0

statement ok
DROP INDEX auto_idx;

# ========================================
# mode=auto explicit — same as default
# ========================================

statement ok
CREATE INDEX auto_explicit ON vecs USING FAISS (embedding) WITH (mode = 'auto');

query II
SELECT v.id, s.distance
FROM faiss_index_scan('vecs', 'auto_explicit', [1.0, 0.0, 0.0], 1) s
JOIN vecs v ON v.rowid = s.row_id;
----
1	0.0

# Insert invalidates GPU copy, search still works
statement ok
INSERT INTO vecs VALUES (4, [0.9, 0.1, 0.0]);

query II
SELECT v.id, s.distance
FROM faiss_index_scan('vecs', 'auto_explicit', [1.0, 0.0, 0.0], 1) s
JOIN vecs v ON v.rowid = s.row_id;
----
1	0.0

statement ok
DROP INDEX auto_explicit;

# ========================================
# mode=auto persistence — flag survives restart
# ========================================

load __TEST_DIR__/faiss_gpu_persist.db

statement ok
CREATE TABLE gpuvecs (id INT, embedding FLOAT[3]);

statement ok
INSERT INTO gpuvecs VALUES
  (1, [1.0, 0.0, 0.0]),
  (2, [0.0, 1.0, 0.0]);

statement ok
CREATE INDEX gpu_persist ON gpuvecs USING FAISS (embedding) WITH (mode = 'auto');

statement ok
CHECKPOINT;

restart

# Search works after restart with mode=auto
query II
SELECT v.id, s.distance
FROM faiss_index_scan('gpuvecs', 'gpu_persist', [1.0, 0.0, 0.0], 1) s
JOIN gpuvecs v ON v.rowid = s.row_id;
----
1	0.0

statement ok
DROP TABLE gpuvecs;
