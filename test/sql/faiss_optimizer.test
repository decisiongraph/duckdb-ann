# name: test/sql/faiss_optimizer.test
# description: Test ANN optimizer rewrite with FAISS indexes
# group: [faiss]

require annsearch

statement ok
CREATE TABLE docs (id INT, embedding FLOAT[3]);

statement ok
INSERT INTO docs VALUES
  (1, [1.0, 0.0, 0.0]),
  (2, [0.0, 1.0, 0.0]),
  (3, [0.0, 0.0, 1.0]),
  (4, [0.5, 0.5, 0.0]),
  (5, [0.0, 0.5, 0.5]);

statement ok
CREATE INDEX faiss_idx ON docs USING FAISS (embedding);

# ========================================
# ORDER BY array_distance LIMIT k â†’ FAISS index scan
# ========================================

query IR
SELECT id, array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS dist
FROM docs
ORDER BY dist, id
LIMIT 3;
----
1	0.0
4	0.70710677
5	1.2247449

# Different query vector
query IR
SELECT id, array_distance(embedding, [0.0, 1.0, 0.0]::FLOAT[3]) AS dist
FROM docs
ORDER BY dist
LIMIT 2;
----
2	0.0
4	0.70710677

# ========================================
# ORDER BY with WHERE filter
# ========================================

statement ok
CREATE TABLE products (id INT, category VARCHAR, embedding FLOAT[3]);

statement ok
INSERT INTO products VALUES
  (1, 'A', [1.0, 0.0, 0.0]),
  (2, 'A', [0.9, 0.1, 0.0]),
  (3, 'B', [0.0, 1.0, 0.0]),
  (4, 'B', [0.0, 0.9, 0.1]),
  (5, 'A', [0.5, 0.5, 0.0]);

statement ok
CREATE INDEX prod_faiss ON products USING FAISS (embedding);

query I
SELECT id
FROM products
WHERE category = 'A'
ORDER BY array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3])
LIMIT 2;
----
1
2

# ========================================
# ORDER BY DESC should NOT rewrite (negative test)
# Descending order is not meaningful for distance search
# ========================================

query IR
SELECT id, array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS dist
FROM docs
ORDER BY dist DESC, id
LIMIT 2;
----
2	1.4142135
3	1.4142135

# ========================================
# Multiple ORDER BY columns should NOT rewrite
# ========================================

query IRI
SELECT id, array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS dist, id AS id2
FROM docs
ORDER BY dist, id2
LIMIT 2;
----
1	0.0	1
4	0.70710677	4

# Clean up
statement ok
DROP INDEX faiss_idx;

statement ok
DROP INDEX prod_faiss;

statement ok
DROP TABLE docs;

statement ok
DROP TABLE products;
